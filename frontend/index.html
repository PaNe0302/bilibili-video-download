<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BiliDownloader</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <style>
    body {
      background: #0f172a;
      color: white;
      font-family: sans-serif;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }
    input, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
    }
    button {
      margin-top: 10px;
      padding: 12px;
      width: 100%;
      border: none;
      background: linear-gradient(to right, #ec4899, #6366f1);
      color: white;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }
    .hidden {
      display: none;
    }
    .result {
      margin-top: 20px;
      background: #1e293b;
      padding: 16px;
      border-radius: 8px;
    }
    .modal-box {
      background: #1e293b;
      padding: 20px;
      border-radius: 10px;
      width: 100%;
      max-width: 400px;
    }
    a.download-link {
      display: block;
      margin-top: 16px;
      padding: 12px;
      background: #6366f1;
      text-align: center;
      color: white;
      border-radius: 6px;
      text-decoration: none;
    }

     /* Style cho thanh tiến trình (tùy chọn) */
    .progress-bar-container {
        width: 100%;
        background-color: #333;
        border-radius: 5px;
        margin-top: 10px;
        overflow: hidden;
    }
    .progress-bar {
        height: 20px;
        width: 0%;
        background-color: #4CAF50;
        text-align: center;
        line-height: 20px;
        color: white;
        font-size: 12px;
    }
     #status-message {
         margin-top: 10px;
         font-size: 14px;
         text-align: center;
     }


  </style>
   <script src='https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.7/dist/ffmpeg.min.js'></script>
</head>
<body>
  <h1 class="text-center">BiliDownloader</h1>

  <!-- Nhập URL -->
  <input type="text" id="video-url" placeholder="Dán URL video Bilibili vào đây" />

  <!-- Nút tải -->
  <button id="download-btn">Lấy thông tin Video</button>

  <!-- Modal nhập SESSDATA -->
  <div id="sessdata-modal" class="modal hidden">
    <div class="modal-box">
      <h2>Nhập SESSDATA</h2>
      <p>Vui lòng nhập SESSDATA hợp lệ để tiếp tục.</p>
      <textarea id="sessdata-input" rows="4" placeholder="Paste SESSDATA vào đây..."></textarea>
      <br/>
      <button onclick="saveSessdata()">Lưu và Tiếp tục</button>
    </div>
  </div>

  <!-- Kết quả -->
  <div id="result" class="result hidden">
    <img id="thumbnail" style="width: 100%; border-radius: 8px;" />
    <p id="video-title" style="margin-top: 10px; font-size: 1.2em; font-weight: bold;"></p>
    
    <!-- Container cho Video Player (Tùy chọn) -->
     <div id="video-player-container" style="margin-top: 10px;">
        <!-- Video player sẽ được thêm vào đây bằng JS -->
     </div>

    <p style="margin-top: 15px; font-weight: bold;">Chọn chất lượng để tải xuống và ghép:</p>
    <!-- Container cho các tùy chọn tải xuống -->
    <div id="download-options">
        <!-- Các nút tải xuống sẽ được thêm vào đây bằng JS -->
    </div>

     <!-- Thanh tiến trình và trạng thái -->
     <div id="progress-container" class="hidden">
         <p id="status-message"></p>
         <div class="progress-bar-container">
             <div id="progress-bar" class="progress-bar" style="width: 0%;">0%</div>
         </div>
     </div>


  </div>

  <script src="env.js"></script>
  <script>
    const urlInput = document.getElementById('video-url');
    const btn = document.getElementById('download-btn');
    const resultDiv = document.getElementById('result');
    const thumbnail = document.getElementById('thumbnail');
    const videoTitleElement = document.getElementById('video-title'); // Thêm phần tử hiển thị tiêu đề
    const videoPlayerContainer = document.getElementById('video-player-container'); // Container player
    const downloadOptionsDiv = document.getElementById('download-options'); // Container tùy chọn tải xuống

    const sessModal = document.getElementById('sessdata-modal');
    const sessInput = document.getElementById('sessdata-input');

    // Phần tử cho tiến trình
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const statusMessage = document.getElementById('status-message');

    let lastSessdata = localStorage.getItem('bilibili_sessdata') || '';

    // Kiểm tra SESSDATA ban đầu (tùy chọn, có thể bỏ qua để backend trả 403)
    // if (!lastSessdata) {
    //   showError("SESSDATA chưa được lưu. Vui lòng nhập SESSDATA.");
    // }

    // Khởi tạo FFmpeg instance
    let ffmpeg = null;
    const createFFmpeg = FFmpeg.createFFmpeg;

    // Hàm tải và khởi tạo FFmpeg
    async function loadFFmpeg() {
      if (ffmpeg && ffmpeg.isLoaded()) return; // Đã load rồi

      // Hiển thị thông báo đang load FFmpeg (tùy chọn)
      statusMessage.textContent = 'Đang tải FFmpeg Wasm...';
      progressContainer.classList.remove('hidden'); // Hiện container progress
      progressBar.style.width = '0%';
      progressBar.textContent = '0%';

      ffmpeg = createFFmpeg({
        log: true, // Hiển thị log của FFmpeg trong console
        // corePath: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.4/dist/ffmpeg-core.js' // Hoặc path đến core file
        // Sử dụng auto-set corePath (mặc định khi dùng CDN)
      });

      // Thêm progress listener
       ffmpeg.setProgress(({ ratio }) => {
           // ratio là từ 0 đến 1
           const percent = (ratio * 100).toFixed(0);
           progressBar.style.width = `${percent}%`;
           progressBar.textContent = `${percent}%`;
           if (ratio < 0) { // Trường hợp ban đầu khi ratio là -1
               statusMessage.textContent = 'Bắt đầu xử lý...';
           } else if (ratio === 1) {
                statusMessage.textContent = 'Hoàn thành ghép video.';
           } else {
               statusMessage.textContent = `Đang xử lý: ${percent}%`;
           }
       });


      try {
        await ffmpeg.load();
        console.log('FFmpeg Wasm loaded.');
        statusMessage.textContent = 'FFmpeg đã sẵn sàng.';
        // progressContainer.classList.add('hidden'); // Ẩn sau khi load xong
      } catch (e) {
         console.error('Failed to load FFmpeg Wasm', e);
         statusMessage.textContent = 'Lỗi: Không thể tải FFmpeg.wasm.';
         // showError('Không thể tải FFmpeg.wasm. Tính năng tải xuống có thể không hoạt động.');
         throw e; // Ném lỗi để xử lý ở nơi gọi
      }
    }


    function showError(msg) {
      alert(msg);
      // Có thể thêm UI để hiển thị lỗi thân thiện hơn
    }

    async function fetchVideoInfo(url, sessdata) {
      statusMessage.textContent = 'Đang lấy thông tin video...';
       progressContainer.classList.remove('hidden'); // Hiện container progress
       progressBar.style.width = '0%';
       progressBar.textContent = '0%';

      try {
        // Sử dụng BACKEND_URL từ env.js
        const response = await fetch(`${BACKEND_URL}/api/video?url=${encodeURIComponent(url)}&sessdata=${encodeURIComponent(sessdata)}`);
        const data = await response.json();

        if (response.status !== 200) {
             // Xử lý các lỗi từ backend
             throw new Error(data.error || `Lỗi từ backend: ${response.status}`);
        }

        return data;
      } catch (err) {
        console.error('Lỗi khi lấy thông tin video:', err);
         statusMessage.textContent = 'Lỗi khi lấy thông tin video.';
        throw err;
      }
    }

    // Hàm hiển thị UI tải xuống dựa trên availableQualities
    function showDownloadUI(data) {
      thumbnail.src = data.thumbnail;
      videoTitleElement.textContent = data.title; // Hiển thị tiêu đề
      resultDiv.classList.remove('hidden');

      // Xóa các tùy chọn tải xuống cũ và player
      downloadOptionsDiv.innerHTML = '';
      videoPlayerContainer.innerHTML = '';

      if (!data.availableQualities || data.availableQualities.length === 0) {
          downloadOptionsDiv.innerHTML = '<p>Không tìm thấy định dạng video/audio phù hợp (>= 720p).</p>';
          progressContainer.classList.add('hidden'); // Ẩn progress nếu không có gì để tải
          return;
      }

       // Tùy chọn: Hiển thị video player với chất lượng tốt nhất
       // Tìm chất lượng có qn cao nhất để hiển thị
       const bestQualityForPlayback = data.availableQualities.reduce((prev, current) => (prev.qn > current.qn) ? prev : current);
       if (bestQualityForPlayback && bestQualityForPlayback.videoUrl) {
           const videoPlayer = document.createElement('video');
           videoPlayer.controls = true;
           videoPlayer.style.width = '100%';
           videoPlayer.src = bestQualityForPlayback.videoUrl; // Chỉ dùng video URL để phát
           // Lưu ý: Phát video DASH (có URL riêng cho video/audio) trực tiếp trong thẻ <video> có thể không hỗ trợ âm thanh. 
           // Cần HLS/DASH player (như hls.js hoặc dash.js) để phát kèm âm thanh.
           // Hiện tại chỉ hiển thị luồng video cho preview đơn giản.
           videoPlayerContainer.appendChild(videoPlayer); // Thêm player
       }

      // Tạo nút tải cho từng chất lượng
      data.availableQualities.forEach(quality => {
          const downloadButton = document.createElement('button');
          downloadButton.textContent = `Tải xuống và ghép: ${quality.label}`; // Ví dụ: Tải xuống và ghép: 1080P
           // Lưu trữ URL và title trong dataset
           downloadButton.dataset.videoUrl = quality.videoUrl;
           downloadButton.dataset.audioUrl = quality.audioUrl;
           downloadButton.dataset.title = data.title || data.bvid;
           downloadButton.classList.add('download-button'); // Thêm class để dễ chọn

          downloadButton.onclick = handleDownloadClick;
          downloadOptionsDiv.appendChild(downloadButton);
      });

      statusMessage.textContent = 'Chọn chất lượng để tải xuống.';
      progressBar.style.width = '0%';
      progressBar.textContent = '0%';
    }

    function saveSessdata() {
      const value = sessInput.value.trim();
      if (!value) return showError('Vui lòng nhập SESSDATA');
      localStorage.setItem('bilibili_sessdata', value);
      lastSessdata = value;
      sessModal.classList.add('hidden');
      // Tự động thử tải lại sau khi lưu sessdata
      startDownload();
    }

    async function startDownload() {
      const url = urlInput.value.trim();
      if (!url || !url.includes('bilibili.com')) {
        showError('URL không hợp lệ. Phải là video từ bilibili.com');
        return;
      }

      // Kiểm tra lại SESSDATA trước khi gọi API video
       if (!lastSessdata) {
          showError("SESSDATA chưa được lưu hoặc hết hạn. Vui lòng nhập SESSDATA.");
          sessModal.classList.remove('hidden'); // Hiển thị popup
          return;
       }

      btn.disabled = true;
      btn.textContent = 'Đang xử lý...';
      resultDiv.classList.add('hidden'); // Ẩn kết quả cũ
      downloadOptionsDiv.innerHTML = ''; // Xóa tùy chọn tải xuống cũ
      videoPlayerContainer.innerHTML = ''; // Xóa player cũ
      progressContainer.classList.remove('hidden'); // Hiển thị container progress

      try {
        console.log('Fetching video info...');
        const data = await fetchVideoInfo(url, lastSessdata);
        console.log('Video info fetched:', data);

        showDownloadUI(data);

      } catch (err) {
        if (err.message.includes('SESSDATA') || err.message.includes('403') || err.message.includes('hết hạn')) {
          showError("SESSDATA đã hết hạn hoặc không hợp lệ. Vui lòng nhập lại.");
          localStorage.removeItem('bilibili_sessdata');
          lastSessdata = ''; // Xóa sessdata trong biến
          sessModal.classList.remove('hidden'); // Hiển thị popup
        } else {
          showError('Lỗi: ' + err.message);
        }
         progressContainer.classList.add('hidden'); // Ẩn progress nếu có lỗi
      } finally {
        btn.disabled = false;
         btn.textContent = 'Lấy thông tin Video';
      }
    }

    // --- FFmpeg.wasm Logic --- //
    async function handleDownloadClick(event) {
        const button = event.target;
        const videoUrl = button.dataset.videoUrl;
        const audioUrl = button.dataset.audioUrl;
        const title = button.dataset.title;

         if (!videoUrl || !audioUrl) {
             showError('Không tìm thấy URL video hoặc audio cho chất lượng này.');
             return;
         }

        // Vô hiệu hóa tất cả các nút tải trong quá trình xử lý
        const downloadButtons = downloadOptionsDiv.querySelectorAll('button');
        downloadButtons.forEach(btn => btn.disabled = true);
        button.textContent = 'Đang tải...'; // Cập nhật trạng thái nút được click

        // Đảm bảo FFmpeg đã load
        if (!ffmpeg || !ffmpeg.isLoaded()) {
             statusMessage.textContent = 'Đang tải FFmpeg. Vui lòng chờ...';
             progressContainer.classList.remove('hidden');
             try {
                 await loadFFmpeg();
                 statusMessage.textContent = 'FFmpeg đã sẵn sàng. Đang tải stream...';
             } catch (e) {
                 showError('Không thể tải FFmpeg. Vui lòng thử lại.');
                  // Bật lại các nút nếu load FFmpeg thất bại
                 downloadButtons.forEach(btn => btn.disabled = false);
                  button.textContent = `Tải xuống và ghép: ${button.textContent.split(':')[1].trim()}`; // Khôi phục text
                  progressContainer.classList.add('hidden');
                 return;
             }
        }

         statusMessage.textContent = 'Đang tải video stream...';
         progressBar.style.width = '0%';
         progressBar.textContent = '0%';

        try {
             // Tải dữ liệu video
            const videoResponse = await fetch(videoUrl);
            if (!videoResponse.ok) throw new Error(\`Lỗi tải video: ${videoResponse.statusText}\`);
             const videoData = await videoResponse.arrayBuffer();

             statusMessage.textContent = 'Đang tải audio stream...';
             progressBar.style.width = '0%';
             progressBar.textContent = '0%';

             // Tải dữ liệu audio
            const audioResponse = await fetch(audioUrl);
             if (!audioResponse.ok) throw new Error(\`Lỗi tải audio: ${audioResponse.statusText}\`);
            const audioData = await audioResponse.arrayBuffer();

            statusMessage.textContent = 'Đang ghi file vào FFmpeg...';
             progressBar.style.width = '10%'; // Giả định một chút tiến độ
             progressBar.textContent = '10%';

            // Ghi dữ liệu vào hệ thống file ảo của FFmpeg
            ffmpeg.FS('writeFile', 'input_video.mp4', new Uint8Array(videoData));
            ffmpeg.FS('writeFile', 'input_audio.aac', new Uint8Array(audioData)); // Giả định audio là aac

            statusMessage.textContent = 'Đang chạy lệnh ghép video...';
            progressBar.style.width = '20%'; // Giả định một chút tiến độ
            progressBar.textContent = '20%';

            // Chạy lệnh FFmpeg để ghép video và audio
            await ffmpeg.run('-i', 'input_video.mp4', '-i', 'input_audio.aac', '-c', 'copy', '-map', '0:v:0', '-map', '1:a:0', 'output.mp4');

            statusMessage.textContent = 'Đang đọc file kết quả...';
             progressBar.style.width = '90%'; // Gần hoàn thành
            progressBar.textContent = '90%';

            // Đọc file output từ hệ thống file ảo của FFmpeg
            const outputData = ffmpeg.FS('readFile', 'output.mp4');

            statusMessage.textContent = 'Đang tạo link tải xuống...';
             progressBar.style.width = '95%'; // Gần hoàn thành
            progressBar.textContent = '95%';

            // Tạo Blob và URL cho file đã ghép
            const blob = new Blob([outputData.buffer], { type: 'video/mp4' });
            const blobUrl = URL.createObjectURL(blob);

            // Tạo link tải về
            const finalDownloadLink = document.createElement('a');
            finalDownloadLink.href = blobUrl;
            finalDownloadLink.download = \`${title || 'video'}_merged.mp4\`; // Tên file tải về
            finalDownloadLink.textContent = \`✅ Tải xuống file đã ghép: ${title || 'video'}.mp4\`;
            finalDownloadLink.classList.add('download-link'); // Dùng lại style css
             finalDownloadLink.style.backgroundColor = '#10b981'; // Màu xanh lá cây

            // Thay thế các nút tải bằng link tải cuối cùng
            downloadOptionsDiv.innerHTML = ''; // Xóa các nút cũ
            downloadOptionsDiv.appendChild(finalDownloadLink);

             statusMessage.textContent = 'Tải xuống đã sẵn sàng!';
             progressBar.style.width = '100%';
             progressBar.textContent = '100%';

             // Giải phóng bộ nhớ (tùy chọn nhưng nên làm với Blob)
             // Khi link bị click hoặc trang unload, Blob URL nên được revoke.
             // Đơn giản nhất là revoke khi trang unload hoặc khi tạo Blob URL mới.
             window.addEventListener('beforeunload', () => URL.revokeObjectURL(blobUrl));

        } catch (err) {
            console.error('Lỗi trong quá trình ghép video/audio:', err);
             statusMessage.textContent = 'Lỗi: Đã xảy ra lỗi khi ghép video và audio.';
            showError('Đã xảy ra lỗi khi ghép video và audio. Chi tiết: ' + err.message);
             // Hiển thị lại các nút tải với thông báo lỗi
             downloadOptionsDiv.innerHTML = ''; // Xóa các nút cũ trước
             const errorMessage = document.createElement('p');
             errorMessage.style.color = 'red';
             errorMessage.textContent = 'Lỗi ghép video. Vui lòng thử lại hoặc chọn chất lượng khác.';
             downloadOptionsDiv.appendChild(errorMessage);

             // Có thể thêm lại các nút tải ban đầu nếu muốn người dùng thử lại
             // Bật lại các nút đã bị vô hiệu hóa
             // downloadButtons.forEach(btn => btn.disabled = false);
             // button.textContent = `Tải xuống và ghép: ${button.textContent.split(':')[1].trim()}`; // Khôi phục text

        } finally {
            // Cleanup FFmpeg filesystem (quan trọng để giải phóng bộ nhớ)
             if (ffmpeg && ffmpeg.FS) { // Kiểm tra ffmpeg và FS có tồn tại không
                 try {
                      // Đọc lại tên file input từ button dataset nếu cần cleanup sau lỗi fetch
                     const videoFileName = 'input_video.mp4';
                     const audioFileName = 'input_audio.aac'; // Giả định
                     const outputFileName = 'output.mp4';

                     ffmpeg.FS('unlink', videoFileName).catch(e => console.warn(`Failed to unlink ${videoFileName}:`, e)); // ignore errors
                     ffmpeg.FS('unlink', audioFileName).catch(e => console.warn(`Failed to unlink ${audioFileName}:`, e)); // ignore errors
                      // Chỉ unlink output nếu nó được tạo thành công
                      try {
                          ffmpeg.FS('stat', outputFileName); // Kiểm tra sự tồn tại trước khi unlink
                          ffmpeg.FS('unlink', outputFileName).catch(e => console.warn(`Failed to unlink ${outputFileName}:`, e)); // ignore errors
                      } catch (e) {
                          // output.mp4 không tồn tại, không cần unlink
                      }

                 } catch (e) {
                     console.error('Lỗi khi dọn dẹp FFmpeg FS:', e);
                 }
             }
             // Giữ progress container để hiển thị trạng thái cuối cùng hoặc lỗi
             // progressContainer.classList.add('hidden'); // Có thể ẩn đi sau vài giây
        }
    }

    btn.addEventListener('click', startDownload);

    // Tự động load FFmpeg khi trang được tải (tùy chọn, có thể load khi cần)
     // loadFFmpeg().catch(e => {
     //     console.error('Failed to load FFmpeg Wasm', e);
     //     showError('Không thể tải FFmpeg.wasm. Tính năng tải xuống có thể không hoạt động.');
     // });

     // Load FFmpeg khi người dùng bắt đầu tương tác (vd: click nút tải lần đầu)

  </script>
</body>
</html>