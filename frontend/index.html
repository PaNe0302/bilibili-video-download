<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BiliDownloader</title>
  <style>
    body {
      background: #0f172a;
      color: white;
      font-family: sans-serif;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }
    input, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
    }
    button {
      margin-top: 10px;
      padding: 12px;
      width: 100%;
      border: none;
      background: linear-gradient(to right, #ec4899, #6366f1);
      color: white;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }
    .result {
      margin-top: 20px;
      background: #1e293b;
      padding: 16px;
      border-radius: 8px;
    }
    .hidden {
      display: none;
    }
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal-box {
      background: #1e293b;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
    }
    a.download-link {
      display: block;
      margin-top: 16px;
      padding: 12px;
      background: #6366f1;
      text-align: center;
      color: white;
      border-radius: 6px;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <h1 class="text-center">BiliDownloader</h1>

  <!-- Nh·∫≠p URL -->
  <input type="text" id="video-url" placeholder="D√°n URL video Bilibili v√†o ƒë√¢y" />

  <!-- N√∫t t·∫£i -->
  <button id="download-btn">T·∫£i V·ªÅ Ngay</button>

  <!-- Modal nh·∫≠p SESSDATA -->
  <div id="sessdata-modal" class="hidden modal">
    <div class="modal-box">
      <h2>Nh·∫≠p SESSDATA</h2>
      <p>Vui l√≤ng nh·∫≠p SESSDATA h·ª£p l·ªá ƒë·ªÉ ti·∫øp t·ª•c.</p>
      <textarea id="sessdata-input" rows="4" placeholder="Paste SESSDATA v√†o ƒë√¢y..."></textarea>
      <br/>
      <button onclick="saveSessdata()">L∆∞u v√† Th·ª≠ l·∫°i</button>
    </div>
  </div>

  <!-- K·∫øt qu·∫£ -->
  <div id="result" class="result hidden">
    <img id="thumbnail" style="width: 100%; border-radius: 8px;" />
    <a id="download-link" class="download-link hidden" href="#">T·∫£i xu·ªëng</a>
  </div>

  <!-- JS logic -->
  <script>
    const urlInput = document.getElementById('video-url');
    const btn = document.getElementById('download-btn');
    const resultDiv = document.getElementById('result');
    const thumbnail = document.getElementById('thumbnail');
    const downloadLink = document.getElementById('download-link');
    const sessModal = document.getElementById('sessdata-modal');
    const sessInput = document.getElementById('sessdata-input');

    let currentUrl = '';
    let lastSessdata = localStorage.getItem('bilibili_sessdata') || '';

    function showError(msg) {
      alert(msg);
    }

    async function fetchVideoInfo(url, sessdata) {
      try {
        const response = await fetch(`https://bilibili-video-download-production.up.railway.app/api/video?url= ${encodeURIComponent(url)}&sessdata=${encodeURIComponent(sessdata)}`);
        const data = await response.json();
        if (response.status === 403) throw new Error('SESSDATA h·∫øt h·∫°n');
        if (data.error) throw new Error(data.error);
        return data;
      } catch (err) {
        throw err;
      }
    }

    function showDownloadUI(data) {
      thumbnail.src = data.thumbnail;
      downloadLink.href = data.format.link;
      downloadLink.textContent = `üîΩ T·∫£i xu·ªëng (${data.format.quality}) - ${data.format.size}`;
      downloadLink.classList.remove('hidden');
    }

    function saveSessdata() {
      const value = sessInput.value.trim();
      if (!value) return showError('Vui l√≤ng nh·∫≠p SESSDATA');
      localStorage.setItem('bilibili_sessdata', value);
      lastSessdata = value;
      sessModal.classList.add('hidden');
      startDownload(currentUrl);
    }

    async function startDownload(inputUrl) {
      currentUrl = inputUrl;
      resultDiv.classList.add('hidden');
      btn.disabled = true;

      if (!lastSessdata) {
        sessModal.classList.remove('hidden');
        btn.disabled = false;
        return;
      }

      try {
        const data = await fetchVideoInfo(inputUrl, lastSessdata);
        showDownloadUI(data);
        resultDiv.classList.remove('hidden');
      } catch (err) {
        if (err.message.includes('SESSDATA')) {
          sessModal.classList.remove('hidden');
        } else {
          alert('L·ªói: ' + err.message);
        }
      } finally {
        btn.disabled = false;
      }
    }

    btn.addEventListener('click', () => {
      const url = urlInput.value.trim();
      startDownload(url);
    });
  </script>
</body>
</html>