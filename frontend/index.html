<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BiliDownloader</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <style>
    body {
      background: #0f172a;
      color: white;
      font-family: sans-serif;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }
    input, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
    }
    button {
      margin-top: 10px;
      padding: 12px;
      width: 100%;
      border: none;
      background: linear-gradient(to right, #ec4899, #6366f1);
      color: white;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }
    .hidden {
      display: none;
    }
    .result {
      margin-top: 20px;
      background: #1e293b;
      padding: 16px;
      border-radius: 8px;
    }
    .modal-box {
      background: #1e293b;
      padding: 20px;
      border-radius: 10px;
      width: 100%;
      max-width: 400px;
    }
    a.download-link {
      display: block;
      margin-top: 16px;
      padding: 12px;
      background: #6366f1;
      text-align: center;
      color: white;
      border-radius: 6px;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <h1 class="text-center">BiliDownloader</h1>

  <!-- Nh·∫≠p URL -->
  <input type="text" id="video-url" placeholder="D√°n URL video Bilibili v√†o ƒë√¢y" />

  <!-- N√∫t t·∫£i -->
  <button id="download-btn">T·∫£i V·ªÅ Ngay</button>

  <!-- Modal nh·∫≠p SESSDATA -->
  <div id="sessdata-modal" class="modal hidden">
    <div class="modal-box">
      <h2>Nh·∫≠p SESSDATA</h2>
      <p>Vui l√≤ng nh·∫≠p SESSDATA h·ª£p l·ªá ƒë·ªÉ ti·∫øp t·ª•c.</p>
      <textarea id="sessdata-input" rows="4" placeholder="Paste SESSDATA v√†o ƒë√¢y..."></textarea>
      <br/>
      <button onclick="saveSessdata()">L∆∞u v√† Ti·∫øp t·ª•c</button>
    </div>
  </div>

  <!-- K·∫øt qu·∫£ -->
  <div id="result" class="result hidden">
    <img id="thumbnail" style="width: 100%; border-radius: 8px;" />
    <a id="download-link" class="download-link hidden" href="#">T·∫£i xu·ªëng</a>
  </div>

  <script src="env.js"></script>
  <script>
    const urlInput = document.getElementById('video-url');
    const btn = document.getElementById('download-btn');
    const resultDiv = document.getElementById('result');
    const thumbnail = document.getElementById('thumbnail');
    const downloadLink = document.getElementById('download-link');
    const sessModal = document.getElementById('sessdata-modal');
    const sessInput = document.getElementById('sessdata-input');

    let lastSessdata = localStorage.getItem('bilibili_sessdata') || '';

    // Ki·ªÉm tra SESSDATA ban ƒë·∫ßu
    if (!lastSessdata) {
      showError("SESSDATA ch∆∞a ƒë∆∞·ª£c l∆∞u. Vui l√≤ng nh·∫≠p SESSDATA.");
    }

    function showError(msg) {
      alert(msg);
    }

    async function fetchVideoInfo(url, sessdata) {
      try {
        const response = await fetch(`${BACKEND_URL}/api/video?url=${encodeURIComponent(url)}&sessdata=${encodeURIComponent(sessdata)}`);
        const data = await response.json();
        // Backend gi·ªù tr·∫£ v·ªÅ 403 n·∫øu SESSDATA kh√¥ng h·ª£p l·ªá khi l·∫•y info video
        if (response.status === 403) throw new Error('SESSDATA h·∫øt h·∫°n ho·∫∑c kh√¥ng h·ª£p l·ªá');
        if (data.error) throw new Error(data.error);
        return data;
      } catch (err) {
        throw err;
      }
    }

    function showDownloadUI(data) {
      thumbnail.src = data.thumbnail;
      // T·∫°o URL cho endpoint download tr√™n backend
      const downloadBackendUrl = `${BACKEND_URL}/api/download?bvid=${data.bvid}&cid=${data.cid}&qn=${data.format.qn}&sessdata=${encodeURIComponent(lastSessdata)}&title=${encodeURIComponent(data.title)}`;

      downloadLink.href = downloadBackendUrl; // S·ª≠ d·ª•ng URL backend download
      downloadLink.textContent = `üîΩ T·∫£i xu·ªëng (${data.format.quality}) - ${data.format.size}`;
      downloadLink.classList.remove('hidden');

      // T·ª± ƒë·ªông t·∫£i xu·ªëng khi link xu·∫•t hi·ªán (t√πy ch·ªçn)
      // downloadLink.click();
    }

    function saveSessdata() {
      const value = sessInput.value.trim();
      if (!value) return showError('Vui l√≤ng nh·∫≠p SESSDATA');
      localStorage.setItem('bilibili_sessdata', value);
      lastSessdata = value;
      sessModal.classList.add('hidden');
      startDownload();
    }

    async function startDownload() {
      const url = urlInput.value.trim();
      if (!url.includes('bilibili.com')) {
        showError('URL kh√¥ng h·ª£p l·ªá. Ph·∫£i l√† video t·ª´ bilibili.com');
        return;
      }

      // Ki·ªÉm tra l·∫°i SESSDATA tr∆∞·ªõc khi g·ªçi API video
       if (!lastSessdata) {
          showError("SESSDATA ch∆∞a ƒë∆∞·ª£c l∆∞u. Vui l√≤ng nh·∫≠p SESSDATA.");
          sessModal.classList.remove('hidden'); // Hi·ªÉn th·ªã popup
          return;
       }

      btn.disabled = true;
      resultDiv.classList.add('hidden'); // ·∫®n k·∫øt qu·∫£ c≈©

      try {
        const data = await fetchVideoInfo(url, lastSessdata);
        showDownloadUI(data);
        resultDiv.classList.remove('hidden');
      } catch (err) {
        if (err.message.includes('SESSDATA') || err.message.includes('403')) {
          showError("SESSDATA ƒë√£ h·∫øt h·∫°n ho·∫∑c kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p l·∫°i.");
          localStorage.removeItem('bilibili_sessdata');
          lastSessdata = ''; // X√≥a sessdata trong bi·∫øn
          sessModal.classList.remove('hidden'); // Hi·ªÉn th·ªã popup
        } else {
          showError('L·ªói: ' + err.message);
        }
      } finally {
        btn.disabled = false;
      }
    }

    btn.addEventListener('click', startDownload);

    // T·ª± ƒë·ªông ki·ªÉm tra SESSDATA khi load trang
    // if (!lastSessdata) {
    //    sessModal.classList.remove('hidden');
    // }

  </script>
</body>
</html>